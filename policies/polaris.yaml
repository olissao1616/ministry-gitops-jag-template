# Polaris Configuration
# Validates Kubernetes best practices

checks:
  # Security
  hostIPCSet: danger
  hostPIDSet: danger
  hostNetworkSet: danger
  privilegeEscalationAllowed: danger
  runAsRootAllowed: danger
  runAsPrivileged: danger
  notReadOnlyRootFilesystem: danger
  cpuRequestsMissing: danger
  cpuLimitsMissing: danger
  memoryRequestsMissing: danger
  memoryLimitsMissing: danger
  sensitiveContainerEnvVar: danger
  sensitiveConfigmapContent: danger
  missingNetworkPolicy: danger

  # Reliability
  statefulSetMissingReplicas: danger
  metadataAndInstanceMismatched: danger
  hpaMaxAvailability: danger
  hpaMinAvailability: danger

  # Images
  tagNotSpecified: danger
  pullPolicyNotAlways: danger
  imageRegistry: danger

  # Health checks
  readinessProbeMissing: danger
  livenessProbeMissing: danger

  # Networking
  tlsSettingsMissing: danger

  # Custom checks for this project
  deploymentMissingReplicas: danger
  priorityClassNotSet: danger
  networkPolicyRequired: danger
  dataClassLabelRequired: danger
  routeAviAnnotationRequired: danger

exemptions:
  - namespace: kube-system
  - namespace: kube-public
  - controllerNames:
      - kube-dns
      - kube-proxy
      - calico-node
      - kindnet
  # Dev-only Bitnami PostgreSQL chart: relax a few checks so template validations pass.
  - controllerNames:
      - test-app-postgresql
    rules:
      - metadataAndInstanceMismatched
      - sensitiveContainerEnvVar

# Mutation webhooks
mutations: []

# Custom messages
customChecks:
  # Override Polaris' built-in `missingNetworkPolicy` check.
  # Our clusters are deny-by-default, so we only require selector coverage
  # (a NetworkPolicy matching pod labels), not explicit ingress+egress rules.
  missingNetworkPolicy:
    successMessage: A NetworkPolicy matches pod labels and contains ingress or egress rules
    failureMessage: A NetworkPolicy should match pod labels and contain applied ingress or egress rules
    category: Security
    target: PodTemplate
    schema:
      '$schema': https://json-schema.org/draft/2019-09/schema
      type: object
      properties:
        metadata:
          type: object
          properties:
            labels:
              type: object
              minProperties: 1
    additionalSchemaStrings:
      networking.k8s.io/NetworkPolicy: |
        type: object
        properties:
          spec:
            type: object
            required: ["podSelector"]
            properties:
              podSelector:
                type: object
                required: ["matchLabels"]
                properties:
                  matchLabels:
                    type: object
                    anyOf:
                    {{ range $key, $value := .Polaris.PodTemplate.metadata.labels }}
                    - properties:
                        "{{ $key }}":
                          type: string
                          const: "{{ $value }}"
                      required: ["{{ $key }}"]
                    {{ end }}

              # Require at least one rule direction. In our deny-by-default clusters,
              # we do not require both ingress and egress rules to be present.
              ingress:
                type: array
                minItems: 1
              egress:
                type: array
                minItems: 1

              # If policyTypes is set, require at least one of Ingress/Egress.
              # (Upstream Polaris used allOf to require both.)
              policyTypes:
                type: array
                anyOf:
                  - contains:
                      pattern: '^(?i)Egress$'
                  - contains:
                      pattern: '^(?i)Ingress$'

            anyOf:
              - required: ["ingress"]
              - required: ["egress"]

  statefulSetMissingReplicas:
    successMessage: StatefulSet replicas are specified
    failureMessage: StatefulSet should explicitly set spec.replicas
    category: Reliability
    target: StatefulSet
    schema:
      '$schema': https://json-schema.org/draft/2019-09/schema
      type: object
      required:
        - spec
      properties:
        spec:
          type: object
          required:
            - replicas
          properties:
            replicas:
              type: integer
              minimum: 1

  imageRegistry:
    successMessage: Image comes from an approved registry
    failureMessage: Image must come from approved registries (OpenShift internal, ghcr.io, docker.io, or Artifactory/JFrog). Docker Hub shorthand (namespace/name) is also allowed.
    category: Security
    target: Container
    schema:
      '$schema': https://json-schema.org/draft/2019-09/schema
      type: object
      required:
        - image
      properties:
        image:
          type: string
          pattern: '^(?:(?:image-registry\.openshift-image-registry\.svc:5000|ghcr\.io|docker\.io|[^/]*artifactory[^/]*|[^/]*jfrog\.io)/|[^./:]+/).+'

  networkPolicyRequired:
    successMessage: NetworkPolicy is defined
    failureMessage: Deployment should have a NetworkPolicy
    category: Security
    target: Deployment
    schema:
      '$schema': http://json-schema.org/draft-07/schema
      type: object
      required:
        - kind
        - metadata
      properties:
        kind:
          const: Deployment

  dataClassLabelRequired:
    successMessage: DataClass label is set
    failureMessage: Pod must have DataClass label (Low/Medium/High)
    category: Security
    target: Deployment
    schema:
      '$schema': http://json-schema.org/draft-07/schema
      type: object
      required:
        - spec
      properties:
        spec:
          type: object
          required:
            - template
          properties:
            template:
              type: object
              required:
                - metadata
              properties:
                metadata:
                  type: object
                  required:
                    - labels
                  properties:
                    labels:
                      type: object
                      required:
                        - DataClass

  routeAviAnnotationRequired:
    successMessage: AVI annotation is set
    failureMessage: Route must have aviinfrasetting.ako.vmware.com/name annotation
    category: Security
    target: Route
    schema:
      '$schema': http://json-schema.org/draft-07/schema
      type: object
      required:
        - kind
        - metadata
      properties:
        kind:
          const: Route
        metadata:
          type: object
          required:
            - annotations
          properties:
            annotations:
              type: object
              required:
                - aviinfrasetting.ako.vmware.com/name
