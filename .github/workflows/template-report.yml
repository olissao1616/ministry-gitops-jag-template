name: Template Usage Report

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  generate:
    name: Generate report artifacts
    runs-on: ubuntu-latest
    outputs:
      has_new_repos: ${{ steps.detect.outputs.has_new_repos }}
      new_repo_count: ${{ steps.detect.outputs.new_repo_count }}
      repos_b64: ${{ steps.detect.outputs.repos_b64 }}
    env:
      GH_TOKEN: ${{ secrets.CI || secrets.GHCR_PAT }}
      ORGS: ${{ vars.TEMPLATE_REPORT_ORGS || 'olissao1616' }}
      PROTECT_ORGS: ${{ vars.TEMPLATE_PROTECT_ORGS || vars.TEMPLATE_REPORT_ORGS || 'olissao1616' }}
      TEMPLATE_FULL_NAME: ${{ vars.TEMPLATE_FULL_NAME || github.repository }}
      NEW_WITHIN_HOURS: ${{ vars.TEMPLATE_NEW_WITHIN_HOURS || '2' }}
      NEW_JSON_FILE: ${{ vars.TEMPLATE_NEW_JSON_FILE || 'reports/new-template-repos.json' }}
      PROTECT_BRANCHES: ${{ vars.TEMPLATE_PROTECT_BRANCHES || 'main,test,develop' }}
      REQUIRED_CONTEXTS: ${{ vars.TEMPLATE_REQUIRED_CONTEXTS || 'policy-check' }}
      REPORT_MODE: ${{ vars.TEMPLATE_REPORT_MODE || 'template-only' }}
      OUTPUT_FILE: reports/template-usage-report.md
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate report
        shell: bash
        env:
          ORGS: ${{ env.ORGS }}
          BRANCHES: ${{ env.PROTECT_BRANCHES }}
          REPORT_MODE: ${{ env.REPORT_MODE }}
          NEW_WITHIN_HOURS: ${{ env.NEW_WITHIN_HOURS }}
          NEW_JSON_FILE: ${{ env.NEW_JSON_FILE }}
          TEMPLATE_FULL_NAME: ${{ env.TEMPLATE_FULL_NAME }}
          OUTPUT_FILE: ${{ env.OUTPUT_FILE }}
        run: |
          set -euo pipefail
          mkdir -p reports
          node scripts/template-report.mjs "$OUTPUT_FILE"

      - name: Detect newly-created repos
        id: detect
        shell: bash
        env:
          NEW_JSON_FILE: ${{ env.NEW_JSON_FILE }}
        run: |
          set -euo pipefail

          if [ ! -f "${NEW_JSON_FILE}" ]; then
            echo "has_new_repos=false" >> "$GITHUB_OUTPUT"
            echo "new_repo_count=0" >> "$GITHUB_OUTPUT"
            echo "repos_b64=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          count="$(node -e "const fs=require('fs'); const p=process.env.NEW_JSON_FILE; const j=JSON.parse(fs.readFileSync(p,'utf8')); const r=Array.isArray(j.repos)?j.repos:[]; process.stdout.write(String(r.length));")"

          repos_b64="$(node -e "const fs=require('fs'); const p=process.env.NEW_JSON_FILE; const j=JSON.parse(fs.readFileSync(p,'utf8')); const r=Array.isArray(j.repos)?j.repos:[]; process.stdout.write(Buffer.from(JSON.stringify(r)).toString('base64'));" )"

          if [ "${count}" = "0" ]; then
            echo "has_new_repos=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_new_repos=true" >> "$GITHUB_OUTPUT"
          fi
          echo "new_repo_count=${count}" >> "$GITHUB_OUTPUT"
          echo "repos_b64=${repos_b64}" >> "$GITHUB_OUTPUT"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: template-report-out
          path: |
            reports/template-usage-report.md
            ${{ env.NEW_JSON_FILE }}
          if-no-files-found: warn
          retention-days: 7

  protect:
    name: Apply branch protection
    needs: generate
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.CI || secrets.GHCR_PAT }}
      PROTECT_ORGS: ${{ vars.TEMPLATE_PROTECT_ORGS || vars.TEMPLATE_REPORT_ORGS || 'olissao1616' }}
      PROTECT_BRANCHES: ${{ vars.TEMPLATE_PROTECT_BRANCHES || 'main,test,develop' }}
      REQUIRED_CONTEXTS: ${{ vars.TEMPLATE_REQUIRED_CONTEXTS || 'policy-check' }}
      NEW_JSON_FILE: ${{ vars.TEMPLATE_NEW_JSON_FILE || 'reports/new-template-repos.json' }}
    steps:
      - name: Download report artifact
        uses: actions/download-artifact@v4
        with:
          name: template-report-out

      - name: Apply branch protection to newly created template repos
        uses: actions/github-script@v7
        env:
          ORGS: ${{ env.PROTECT_ORGS }}
          BRANCHES: ${{ env.PROTECT_BRANCHES }}
          REQUIRED_CONTEXTS: ${{ env.REQUIRED_CONTEXTS }}
          NEW_JSON_FILE: ${{ env.NEW_JSON_FILE }}
        with:
          github-token: ${{ env.GH_TOKEN }}
          script: |
            const fs = require('fs');
            const path = process.env.NEW_JSON_FILE;
            const allowOrgs = (process.env.ORGS || '').split(/\s+/).filter(Boolean);
            const branches = String(process.env.BRANCHES || 'main,test,develop')
              .split(',').map(s => s.trim()).filter(Boolean);
            const contexts = String(process.env.REQUIRED_CONTEXTS || 'policy-check')
              .split(',').map(s => s.trim()).filter(Boolean);

            if (!path || !fs.existsSync(path)) {
              core.info('No new repo JSON file found; skipping protection.');
              return;
            }

            const payload = JSON.parse(fs.readFileSync(path, 'utf8'));
            const repos = Array.isArray(payload.repos) ? payload.repos : [];

            if (!repos.length) {
              core.info('No newly-created repos detected; nothing to protect.');
              return;
            }

            core.info(`New repos detected: ${repos.join(', ')}`);

            for (const full of repos) {
              if (typeof full !== 'string' || !full.includes('/')) continue;
              const [owner, repo] = full.split('/', 2);
              if (allowOrgs.length && !allowOrgs.includes(owner)) {
                core.info(`Skipping ${full} (owner not in ORGS allowlist)`);
                continue;
              }

              for (const branch of branches) {
                core.info(`Protecting ${full}:${branch}`);
                try {
                  await github.rest.repos.updateBranchProtection({
                    owner,
                    repo,
                    branch,
                    required_status_checks: {
                      strict: true,
                      contexts,
                    },
                    enforce_admins: true,
                    required_pull_request_reviews: {
                      dismiss_stale_reviews: true,
                      require_code_owner_reviews: true,
                      required_approving_review_count: 2,
                    },
                    restrictions: null,
                    required_linear_history: true,
                    allow_force_pushes: false,
                    allow_deletions: false,
                    required_conversation_resolution: true,
                  });
                  core.info(`âœ“ Protected ${full}:${branch}`);
                } catch (err) {
                  const status = err?.status ?? err?.response?.status;
                  const message = err?.message || String(err);

                  if (status === 404 || status === 422) {
                    core.warning(`Skipped ${full}:${branch} (${status}): ${message}`);
                    continue;
                  }

                  core.warning(`Failed ${full}:${branch} (${status ?? 'unknown'}): ${message}`);
                }
              }
            }

  sync_validation:
    name: Sync tenant validation workflows
    needs: generate
    if: ${{ needs.generate.outputs.has_new_repos == 'true' }}
    uses: ./.github/workflows/sync-tenant-workflows.yaml
    with:
      repos_b64: ${{ needs.generate.outputs.repos_b64 }}
      branches: ${{ vars.TEMPLATE_PROTECT_BRANCHES || 'main,test,develop' }}
      allow_orgs: ${{ vars.TEMPLATE_PROTECT_ORGS || vars.TEMPLATE_REPORT_ORGS || 'olissao1616' }}
      copy_ci: true
      enforce_only: true
    secrets: inherit

  persist:
    name: Persist report to repo
    needs: generate
    if: always()
    runs-on: ubuntu-latest
    env:
      NEW_JSON_FILE: ${{ vars.TEMPLATE_NEW_JSON_FILE || 'reports/new-template-repos.json' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          persist-credentials: false

      - name: Download report artifact
        uses: actions/download-artifact@v4
        with:
          name: template-report-out

      - name: Persist report (overwrite)
        shell: bash
        env:
          PUSH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          if [ -z "${PUSH_TOKEN:-}" ]; then
            echo "Missing PUSH_TOKEN (github.token)" >&2
            exit 1
          fi
          git remote set-url origin "https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          BRANCH="${GITHUB_REF_NAME:-${GITHUB_REF##*/}}"
          git fetch --no-tags --prune origin "+refs/heads/${BRANCH}:refs/remotes/origin/${BRANCH}"
          git checkout -B "${BRANCH}" "origin/${BRANCH}"

          mkdir -p reports
          # Artifact download preserves paths; these should now exist in the workspace.
          test -f reports/template-usage-report.md || true
          test -f "${NEW_JSON_FILE}" || true

          git add reports/template-usage-report.md || true
          git add "${NEW_JSON_FILE}" || true
          git commit -m "[skip ci] chore(report): update template usage report" || echo "No changes to commit"
          git push origin "${BRANCH}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: template-usage-report
          path: |
            reports/template-usage-report.md
            ${{ env.NEW_JSON_FILE }}
          if-no-files-found: warn

  summary:
    name: Summary
    needs: [generate, sync_validation, protect, persist]
    if: always()
    runs-on: ubuntu-latest
    env:
      ORGS: ${{ vars.TEMPLATE_REPORT_ORGS || 'olissao1616' }}
      TEMPLATE_FULL_NAME: ${{ vars.TEMPLATE_FULL_NAME || github.repository }}
      PROTECT_BRANCHES: ${{ vars.TEMPLATE_PROTECT_BRANCHES || 'main,test,develop' }}
    steps:
      - name: Add summary
        shell: bash
        run: |
          echo "## Template usage report" >> "$GITHUB_STEP_SUMMARY"
          echo "Template: ${TEMPLATE_FULL_NAME:-<unset>}" >> "$GITHUB_STEP_SUMMARY"
          echo "Owners scanned: ${ORGS}" >> "$GITHUB_STEP_SUMMARY"
          echo "Branches checked: ${PROTECT_BRANCHES:-<unset>}" >> "$GITHUB_STEP_SUMMARY"
          echo "New repos detected: ${{ needs.generate.outputs.new_repo_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Job results" >> "$GITHUB_STEP_SUMMARY"
          echo "- Generate: ${{ needs.generate.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Sync validation: ${{ needs.sync_validation.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Protect: ${{ needs.protect.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Persist: ${{ needs.persist.result }}" >> "$GITHUB_STEP_SUMMARY"
