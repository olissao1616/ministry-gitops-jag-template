name: Template Usage Report

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  report:
    runs-on: ubuntu-latest
    env:
      # Token for GitHub API operations in this workflow.
      # Must be a PAT (or GitHub App token) with permission to:
      # - read org repos listed in ORGS
      # - update branch protection on newly-created repos
      # Prefer CI (admin-capable PAT). GHCR_PAT is often packages-only and may not have repo admin rights.
      GH_TOKEN: ${{ secrets.CI || secrets.GHCR_PAT }}
      # Configurable via repo/org variables (Settings -> Secrets and variables -> Actions -> Variables)
      # Space-separated org list to scan.
      ORGS: ${{ vars.TEMPLATE_REPORT_ORGS || 'olissao1616' }}
      # Space-separated org allowlist for applying protection (defaults to ORGS).
      PROTECT_ORGS: ${{ vars.TEMPLATE_PROTECT_ORGS || vars.TEMPLATE_REPORT_ORGS || 'olissao1616' }}
      # Template to match when detecting template-derived repos.
      TEMPLATE_FULL_NAME: ${{ vars.TEMPLATE_FULL_NAME || github.repository }}
      # How far back to consider a repo "new".
      NEW_WITHIN_HOURS: ${{ vars.TEMPLATE_NEW_WITHIN_HOURS || '2' }}
      NEW_JSON_FILE: ${{ vars.TEMPLATE_NEW_JSON_FILE || 'reports/new-template-repos.json' }}
      # Protection settings
      PROTECT_BRANCHES: ${{ vars.TEMPLATE_PROTECT_BRANCHES || 'main,test,develop' }}
      REQUIRED_CONTEXTS: ${{ vars.TEMPLATE_REQUIRED_CONTEXTS || 'policy-check' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate report
        id: gen
        env:
          ORGS: ${{ env.ORGS }}
          BRANCHES: ${{ env.PROTECT_BRANCHES }}
          NEW_WITHIN_HOURS: ${{ env.NEW_WITHIN_HOURS }}
          NEW_JSON_FILE: ${{ env.NEW_JSON_FILE }}
          TEMPLATE_FULL_NAME: ${{ env.TEMPLATE_FULL_NAME }}
          OUTPUT_FILE: reports/template-usage-report.md
        run: |
          set -euo pipefail
          mkdir -p reports
          node scripts/template-report.mjs "$OUTPUT_FILE"
          echo "file=$OUTPUT_FILE" >> "$GITHUB_OUTPUT"

      - name: Apply branch protection to newly created template repos
        uses: actions/github-script@v7
        env:
          ORGS: ${{ env.PROTECT_ORGS }}
          BRANCHES: ${{ env.PROTECT_BRANCHES }}
          REQUIRED_CONTEXTS: ${{ env.REQUIRED_CONTEXTS }}
          NEW_JSON_FILE: ${{ env.NEW_JSON_FILE }}
        with:
          github-token: ${{ env.GH_TOKEN }}
          script: |
            const fs = require('fs');
            const path = process.env.NEW_JSON_FILE;
            const allowOrgs = (process.env.ORGS || '').split(/\s+/).filter(Boolean);
            const branches = String(process.env.BRANCHES || 'main,test,develop')
              .split(',').map(s => s.trim()).filter(Boolean);
            const contexts = String(process.env.REQUIRED_CONTEXTS || 'policy-check')
              .split(',').map(s => s.trim()).filter(Boolean);

            if (!path || !fs.existsSync(path)) {
              core.info('No new repo JSON file found; skipping protection.');
              return;
            }

            const payload = JSON.parse(fs.readFileSync(path, 'utf8'));
            const repos = Array.isArray(payload.repos) ? payload.repos : [];

            if (!repos.length) {
              core.info('No newly-created repos detected; nothing to protect.');
              return;
            }

            core.info(`New repos detected: ${repos.join(', ')}`);

            for (const full of repos) {
              if (typeof full !== 'string' || !full.includes('/')) continue;
              const [owner, repo] = full.split('/', 2);
              if (allowOrgs.length && !allowOrgs.includes(owner)) {
                core.info(`Skipping ${full} (owner not in ORGS allowlist)`);
                continue;
              }

              for (const branch of branches) {
                core.info(`Protecting ${full}:${branch}`);
                try {
                  await github.rest.repos.updateBranchProtection({
                    owner,
                    repo,
                    branch,
                    required_status_checks: {
                      strict: true,
                      contexts,
                    },
                    enforce_admins: true,
                    required_pull_request_reviews: {
                      dismiss_stale_reviews: true,
                      require_code_owner_reviews: true,
                      required_approving_review_count: 2,
                    },
                    restrictions: null,
                    required_linear_history: true,
                    allow_force_pushes: false,
                    allow_deletions: false,
                    required_conversation_resolution: true,
                  });
                  core.info(`âœ“ Protected ${full}:${branch}`);
                } catch (err) {
                  const status = err?.status ?? err?.response?.status;
                  const message = err?.message || String(err);

                  // Common cases: branch doesn't exist yet, repo isn't ready, or permissions missing.
                  if (status === 404 || status === 422) {
                    core.warning(`Skipped ${full}:${branch} (${status}): ${message}`);
                    continue;
                  }

                  core.warning(`Failed ${full}:${branch} (${status ?? 'unknown'}): ${message}`);
                }
              }
            }

      - name: Persist report to main (overwrite)
        shell: bash
        env:
          # Use the repo-scoped GITHUB_TOKEN for pushing commits back to this repo.
          # This avoids failures when the PAT is fine-grained / not granted to this repo.
          PUSH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          # Push using the workflow token (scoped to this repository)
          if [ -z "${PUSH_TOKEN:-}" ]; then
            echo "Missing PUSH_TOKEN (github.token)" >&2
            exit 1
          fi
          git remote set-url origin "https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Ensure we're on the branch this workflow is running from (schedule uses default branch)
          BRANCH="${GITHUB_REF_NAME:-${GITHUB_REF##*/}}"
          git fetch --no-tags --prune origin "+refs/heads/${BRANCH}:refs/remotes/origin/${BRANCH}"
          git checkout -B "${BRANCH}" "origin/${BRANCH}"

          # Rebase cleanly even though we just generated files in the working tree
          git stash push -u -m "template-report" || true
          git pull --rebase origin "${BRANCH}" || true
          git stash pop || true

          # Overwrite-in-place: commit the latest report and the new repo JSON (if present)
          git add reports/template-usage-report.md || true
          git add "${NEW_JSON_FILE}" || true
          git commit -m "[skip ci] chore(report): update template usage report" || echo "No changes to commit"
          git push origin "${BRANCH}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: template-usage-report
          path: |
            reports/template-usage-report.md
            ${{ env.NEW_JSON_FILE }}
          if-no-files-found: warn

      - name: Add report to job summary
        if: always()
        shell: bash
        env:
          ORGS: ${{ env.ORGS }}
          TEMPLATE_FULL_NAME: ${{ env.TEMPLATE_FULL_NAME }}
          PROTECT_BRANCHES: ${{ env.PROTECT_BRANCHES }}
        run: |
          echo "## Template usage report" >> "$GITHUB_STEP_SUMMARY"
          echo "Template: ${TEMPLATE_FULL_NAME:-<unset>}" >> "$GITHUB_STEP_SUMMARY"
          echo "Owners scanned: ${ORGS}" >> "$GITHUB_STEP_SUMMARY"
          echo "Branches checked: ${PROTECT_BRANCHES:-<unset>}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f reports/template-usage-report.md ]; then
            cat reports/template-usage-report.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No report found" >> "$GITHUB_STEP_SUMMARY"
          fi
