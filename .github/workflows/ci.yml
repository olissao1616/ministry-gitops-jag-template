name: CI

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.yaml'
      - '**/*.tpl'
      - '**/Chart.yaml'
  pull_request:
    branches: [ main ]

jobs:
  lint-and-template:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm version
        run: helm version --short

      - name: Lint library chart
        run: |
          helm lint ./shared-lib/ag-helm
      
      - name: Helm login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin


      - name: Build dependencies for example-app
        run: |
          helm dependency update ./shared-lib/example-app

      - name: Lint example-app
        run: |
          helm lint ./shared-lib/example-app

      - name: Template example-app (values-examples.yaml)
        run: |
          helm template ex ./shared-lib/example-app --values ./shared-lib/example-app/values-examples.yaml --debug > ./example-app-render.yaml

      - name: Upload render artifact
        uses: actions/upload-artifact@v4
        with:
          name: example-app-render
          path: ./example-app-render.yaml

  publish-helm-library:
    runs-on: ubuntu-latest
    needs: lint-and-template
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    env:
      CHART_DIR: ./shared-lib/ag-helm
      CHART_NAME: ag-helm-templates
      OCI_REGISTRY: ghcr.io/olissao1616/helm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version and create development tag
        id: version
        run: |
          VERSION=$(grep -E '^version:' ${CHART_DIR}/Chart.yaml | awk '{print $2}')
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          DEV_VERSION="${VERSION}-dev.${SHORT_SHA}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "dev_version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing version: ${DEV_VERSION}"

      - name: Update Chart.yaml with dev version
        run: |
          sed -i -E "s/^version: .*/version: ${{ steps.version.outputs.dev_version }}/" ${CHART_DIR}/Chart.yaml
          cat ${CHART_DIR}/Chart.yaml

      - name: Package chart
        run: |
          mkdir -p dist
          helm lint ${CHART_DIR}
          helm package ${CHART_DIR} -d dist
          ls -l dist

      - name: Push to OCI (dev version)
        run: |
          FILE=$(ls dist/${CHART_NAME}-*.tgz | head -n1)
          echo "Pushing $FILE to oci://${OCI_REGISTRY}"
          helm push "$FILE" oci://${OCI_REGISTRY}
          echo "âœ… Published: oci://${OCI_REGISTRY}/${CHART_NAME}:${{ steps.version.outputs.dev_version }}"
