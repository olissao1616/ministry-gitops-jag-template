name: Network Policy Validation

on:
  push:
    branches: [main, develop]
    paths: ['charts/**', 'deploy/**', '.github/workflows/**']
  pull_request:
    branches: [main, develop]
    paths: ['charts/**', 'deploy/**', '.github/workflows/**']

permissions:
  contents: read

env:
  POLICY_SOURCE_ORG: ${{ vars.POLICY_SOURCE_ORG || github.repository_owner }}
  POLICY_SOURCE_REPO: ministry-gitops-jag-template

jobs:
  render:
    if: ${{ github.repository != 'bcgov-c/ministry-gitops-jag-template' }}
    name: Render (${{ matrix.env }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Update Helm dependencies
        run: |
          cd charts/gitops
          helm dependency update

      - name: Render manifests
        run: |
          set -euo pipefail
          helm template gitops-app-${{ matrix.env }} ./charts/gitops \
            --values ./deploy/${{ matrix.env }}_values.yaml \
            --namespace ${{ matrix.env }} \
            > /tmp/rendered-${{ matrix.env }}.yaml
          echo "âœ“ Rendered $(wc -l < /tmp/rendered-${{ matrix.env }}.yaml) lines"

      - name: Upload rendered manifests
        uses: actions/upload-artifact@v4
        with:
          name: rendered-${{ matrix.env }}
          path: /tmp/rendered-${{ matrix.env }}.yaml
          retention-days: 7

  conftest:
    if: ${{ github.repository != 'bcgov-c/ministry-gitops-jag-template' }}
    name: Conftest (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Install Conftest
        run: |
          wget -q https://github.com/open-policy-agent/conftest/releases/download/v0.49.1/conftest_0.49.1_Linux_x86_64.tar.gz
          tar xzf conftest_0.49.1_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Download centralized policies
        run: |
          mkdir -p /tmp/policies
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -L "https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/main/policies/network-policies.rego" \
            -o /tmp/policies/network-policies.rego
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -L "https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/main/policies/avi-infrasetting-annotation.rego" \
            -o /tmp/policies/avi-infrasetting-annotation.rego
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -L "https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/main/policies/routes-edge-termination.rego" \
            -o /tmp/policies/routes-edge-termination.rego

      - name: Run Conftest
        run: |
          conftest test rendered-${{ matrix.env }}.yaml \
            --policy /tmp/policies/ \
            --all-namespaces \
            --output table \
            --fail-on-warn

  kube-linter:
    if: ${{ github.repository != 'bcgov-c/ministry-gitops-jag-template' }}
    name: kube-linter (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Install kube-linter
        run: |
          wget -q https://github.com/stackrox/kube-linter/releases/download/v0.6.8/kube-linter-linux.tar.gz
          tar -xzf kube-linter-linux.tar.gz
          sudo mv kube-linter /usr/local/bin/
          kube-linter version

      - name: Download kube-linter config
        run: |
          mkdir -p /tmp/policies
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -L "https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/main/policies/kube-linter.yaml" \
            -o /tmp/policies/kube-linter.yaml

      - name: Run kube-linter
        run: |
          kube-linter lint rendered-${{ matrix.env }}.yaml --config /tmp/policies/kube-linter.yaml

  polaris:
    if: ${{ github.repository != 'bcgov-c/ministry-gitops-jag-template' }}
    name: Polaris (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Download Polaris config
        run: |
          mkdir -p /tmp/policies
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -L "https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/main/policies/polaris.yaml" \
            -o /tmp/policies/polaris.yaml

      - name: Run Polaris
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -v /tmp/policies/polaris.yaml:/tmp/polaris.yaml \
            quay.io/fairwinds/polaris:8.5.0 \
            polaris audit \
            --audit-path /app/rendered-${{ matrix.env }}.yaml \
            --config /tmp/polaris.yaml \
            --format pretty \
            --set-exit-code-below-score 100

  datree:
    if: ${{ github.repository != 'bcgov-c/ministry-gitops-jag-template' }}
    name: Datree (helm) (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Install Datree Helm plugin
        run: |
          helm plugin install https://github.com/datreeio/helm-datree
          helm plugin update datree
          helm datree config set offline local

      - name: Download centralized Datree policies
        run: |
          mkdir -p /tmp/policies
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -L "https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/main/policies/datree-policies.yaml" \
            -o /tmp/policies/datree-policies.yaml

      - name: Run Helm Datree policy enforcement
        run: |
          set -euo pipefail
          helm dependency update ./charts/gitops

          helm datree test --ignore-missing-schemas \
            --policy-config /tmp/policies/datree-policies.yaml \
            --include-tests ./charts/gitops \
            -- --namespace "${{ matrix.env }}" --values "./deploy/${{ matrix.env }}_values.yaml" "gitops-app-${{ matrix.env }}"

  summary:
    name: Validation summary
    if: ${{ always() && github.repository != 'bcgov-c/ministry-gitops-jag-template' }}
    needs:
      - render
      - conftest
      - kube-linter
      - polaris
      - datree
    runs-on: ubuntu-latest
    steps:
      - name: Write summary
        run: |
          echo "# Network policy validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Helm render (dev/test/prod) -> validators (Conftest, kube-linter, Polaris, Datree)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job results" >> $GITHUB_STEP_SUMMARY
          echo "- Render: ${{ needs.render.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Conftest: ${{ needs.conftest.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- kube-linter: ${{ needs.kube-linter.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Polaris: ${{ needs.polaris.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Datree (helm): ${{ needs.datree.result }}" >> $GITHUB_STEP_SUMMARY


